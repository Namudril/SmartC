<!DOCTYPE html>
<html>
  <head>
    <style>
      /*! ADAPTED
    Typeplate : Starter Kit
    URL ........... http://typeplate.com
    Version ....... 3.0.2
    Github ........ https://github.com/typeplate/starter-kit
    Authors ....... Dennis Gaebel (@gryghostvisuals) & Zachary Kain (@zakkain)
    License ....... Creative Commmons Attribution 3.0
    License URL ... https://github.com/typeplate/starter-kit/blob/master/license.txt
    */

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        text-rendering: optimizeLegibility;
        line-height: 1;
        margin-top: 0;
        color: #222;
      }

      blockquote + figcaption cite {
        display: block;
        font-size: inherit;
        text-align: right;
      }

      body {
        word-wrap: break-word;
      }

      pre code {
        word-wrap: normal;
      }

      body {
        -webkit-hyphens: auto;
        -ms-hyphens: auto;
        hyphens: auto;
        color: #444;
      }

      h1 {
        font-size: 2em;
        /* 2*16 = 32 */
      }

      h2 {
        font-size: 1.5em;
        /* 1.5*16 = 24 */
      }

      h3 {
        font-size: 1.17em;
        /* 1.17*16 = 18.72 */
      }

      h4 {
        font-size: 1em;
        /* 1*16 = 16 */
      }

      h5 {
        font-size: 0.83em;
        /* 0.83*16 = 13.28 */
      }

      h6 {
        font-size: 0.75em;
        /* 0.75*16 = 12 */
      }

      h1 {
        margin: 2.42424rem 0 1.454544rem;
      }

      h2 {
        margin: 2.0202rem 0 1.21212rem;
      }

      h3 {
        margin: 1.61616rem 0 1rem;
      }

      h4 {
        margin: 1.21212rem 0 1;
      }

      h5 {
        margin: 0.80808rem 0;
      }

      h6 {
        margin: 0.70707rem 0;
      }

      p {
        margin: auto auto 1.5rem;
      }

      small {
        font-size: 65%;
      }

      input,
      abbr,
      acronym,
      blockquote,
      code,
      kbd,
      q,
      samp,
      var {
        -webkit-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
      }

      pre {
        white-space: pre;
      }

      pre code {
        white-space: -moz-pre-wrap;
        white-space: pre-wrap;
      }

      code {
        white-space: pre;
        font-family: SF Mono, Consolas, Dejavu Sans Mono, Menlo, monospace;
      }

      abbr {
        -webkit-font-variant: small-caps;
        -moz-font-variant: small-caps;
        -ms-font-variant: small-caps;
        font-variant: small-caps;
        font-weight: 600;
        text-transform: lowercase;
        color: gray;
      }

      abbr[title]:hover {
        cursor: help;
      }

      /* FROM http://purecss.io/layouts/side-menu/  adapted to remove pure classes*/

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
        color: #444;
      }

      img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: auto;
      }

      code,
      pre {
        background-color: #f5f5f5;
        color: #444;
        border-radius: 2px;
        text-shadow: 0px 1px 0px white;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
      }

      pre code {
        border: none;
        box-shadow: none;
      }

      pre {
        padding: 0.5em;
      }

      code {
        display: inline-block;
        padding: 0 0.5em;
        line-height: 1.4;
        font-size: 0.9em;
      }

      table {
        border-spacing: 0;
        margin-bottom: 1.5rem;
      }

      table th,
      table td {
        padding: 0.3em 0.7em;
      }

      table th {
        background-color: #f4f4f4;
        border-bottom: 2px solid #444;
      }

      table td {
        border: 1px solid #f5f5f5;
      }

      /* Add transition to containers so they can push in and out. */

      #layout,
      #menu,
      .menu-link {
        -webkit-transition: all 0.2s ease-out;
        -moz-transition: all 0.2s ease-out;
        -ms-transition: all 0.2s ease-out;
        -o-transition: all 0.2s ease-out;
        transition: all 0.2s ease-out;
      }

      /* This is the parent `<div>` that contains the menu and the content area. */

      #layout {
        position: relative;
        padding-left: 0;
      }

      #layout.active #menu {
        left: 250px;
        width: 250px;
      }

      #layout.active .menu-link {
        left: 250px;
      }

      /* The content `<div>` is where all your content goes. */

      .content {
        margin: 50px auto;
        padding: 0 2em;
        max-width: 80ex;
        line-height: 1.6em;
      }

      /*
      The `#menu` `<div>` is the parent `<div>` that contains the menu that
      appears on the left side of the page.
      */

      #menu {
        margin-left: -250px;
        /* "#menu" width */
        width: 250px;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        z-index: 1000;
        /* so the menu or its navicon stays above all content */
        background: #f4f4f4;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        font-size: 0.9em;
      }

      @media print {
        #menu,
        .menu-link {
          display: none !important;
        }
      }

      a,
      a * {
        text-decoration: none;
        color: #2483cc;
      }

      a:visited {
        text-decoration: none;
        color: #2483cc;
      }

      /* All anchors inside the menu should be styled like this. */

      #menu a {
        display: block;
        padding: 0.5em 0.5em;
      }

      #menu a:first-letter {
        text-transform: capitalize;
      }

      #menu ul {
        list-style-type: none;
        padding: 0;
        margin: 1em 0.5em;
      }

      #menu ul ul {
        margin-top: 0.5em;
        margin-left: 0.5em;
        border-left: 4px solid rgba(255, 255, 255, 0.5);
      }

      /* Change color of the anchor links on hover/focus. */

      #menu li a:hover,
      #menu li a:focus {
        background: rgba(255, 255, 255, 0.4);
      }

      /* This styles the selected menu item `<li>`. */

      #menu li a.active {
        background: rgba(0, 0, 0, 0.05);
      }

      /* This styles a link within a selected menu item `<li>`. */

      #menu li a.active {
        color: #222;
      }

      /* This styles the menu heading. */

      #menu li.heading {
        font-size: 0.9em;
        text-transform: uppercase;
        color: #000;
      }

      #menu li.heading > * {
        padding: 0.5em;
        display: block;
      }

      #menu li.heading a {
        color: #0c68af;
      }

      /* -- Dynamic Button For Responsive Menu -------------------------------------*/

      /*
      `.menu-link` represents the responsive menu toggle that shows/hides on
      small screens.
      */

      .menu-link {
        position: fixed;
        display: block;
        /* show this only on small screens */
        top: 0;
        left: 0;
        /* "#menu width" */
        font-size: 10px;
        /* change this value to increase/decrease button size */
        z-index: 10;
        width: 2em;
        height: auto;
        padding: 1.6em 1.2em;
        border-radius: 0 2px 2px 0;
      }

      .menu-link:hover {
        background: #f4f4f4;
      }

      .menu-link span {
        position: relative;
        display: block;
      }

      .menu-link span,
      .menu-link span:before,
      .menu-link span:after {
        background-color: #555;
        width: 100%;
        height: 0.2em;
        border-radius: 1em;
      }

      .menu-link span:before,
      .menu-link span:after {
        position: absolute;
        margin-top: -0.6em;
        content: " ";
      }

      .menu-link span:after {
        margin-top: 0.6em;
      }

      /* Hides the menu at `48em`, but modify this based on your app's needs. */

      @media (min-width: 48em) {
        .header,
        .content {
          padding-left: 2em;
          padding-right: 2em;
        }

        #layout {
          padding-left: 250px;
          /* left col width "#menu" */
          left: 0;
        }
        #menu {
          left: 250px;
        }

        .menu-link {
          position: fixed;
          left: 250px;
          display: none;
        }

        #layout.active .menu-link {
          left: 250px;
        }
      }

      @media (max-width: 48em) {
        /* Only apply this when the window is small. Otherwise, the following case results in extra padding on the left:
         * Make the window small.
         * Tap the menu to trigger the active state.
         * Make the window large again.
         */
        #layout.active {
          position: relative;
          left: 250px;
        }
      }

      /* Heading anchors and permalinks */
      h1[id],
      h2[id],
      h3[id],
      h4[id],
      h5[id],
      h6[id] {
        position: relative;
      }
      .heading-anchor-permalink {
        /* Position the permalink to the left of the title */
        position: absolute;
        right: 100%;
        /* Add some spacing as padding to not lose the hover */
        padding-right: 0.6rem;
        /* Make it only visible on heading hover, see below */
        opacity: 0;
      }
      h1[id]:hover .heading-anchor-permalink,
      h2[id]:hover .heading-anchor-permalink,
      h3[id]:hover .heading-anchor-permalink,
      h4[id]:hover .heading-anchor-permalink,
      h5[id]:hover .heading-anchor-permalink,
      h6[id]:hover .heading-anchor-permalink {
        opacity: 0.5;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
  </head>

  <body>
    <div id="layout">
      <!-- Menu toggle -->
      <a href="#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon -->
        <span></span>
      </a>
      <nav id="menu">
        <ul>
<li><a class="" href="../README.html">README</a></li>
<li><a class="" href="../1-Basis.html">Basis</a></li>
<li><a class="" href="../2-API-Pseudo-Code.html">API Pseudo Code</a></li>
<li><a class="" href="../3-Learning-with-examples.html">Learning with examples</a></li>
<li><a class="" href="../4-Functions-repository.html">Functions repository</a></li>
<li><a class="" href="../5-Comprehensive-example.html">Comprehensive example</a></li>
<li><a class="" href="../6-Deeper-into-SmartC.html">Deeper into SmartC</a></li>
<li><a class="" href="../Non-Technical-FAQ.html">Non Technical FAQ</a></li>
<li class="heading"><span>commemorative</span></li>
<ul>
<li><a class="" href="README.html">README</a></li>
<li><a class="" href="v0.1_SmartC_NFT.html">v0.1 SmartC NFT</a></li>
<li><a class="" href="v0.2_PromotionalRaffle227.html">v0.2 PromotionalRaffle227</a></li>
<li><a class="active" href="v0.3_Hive_The_Tumbler.html">v0.3 Hive The Tumbler</a></li>
</ul>
</ul>
      </nav>
      <article id="main" class="content">
        <h1 id="hive%2C-the-tumbler">Hive, the tumbler <a class="heading-anchor-permalink" href="#hive%2C-the-tumbler">#</a></h1>
<p>The tumbler objective is to split and bounce transactions, making dificult to trace back transactions.
<strong>This contract swarm does not make the payments anonymous, but it adds a layer of obfuscation against eavesdroppers</strong>
contracts to be deployed after ‘Signum Speedway’ fork, to take advantage of Carbon copy smarts contracts new feature.</p>
<h2 id="bee-contract">Bee contract <a class="heading-anchor-permalink" href="#bee-contract">#</a></h2>
<p>Bees transport signa between the users and the <strong>Hive contract</strong>. There are 256 equal contracts. If they receive a big load from the hive, they will bounce it back, actually just delaying processing. If a bee receive a small load (less than 10 signa) it will deliver to destination.</p>
<h2 id="hive-contract">Hive contract <a class="heading-anchor-permalink" href="#hive-contract">#</a></h2>
<p>Hive splits transactions and distribute pseudo-randomly between the bees. Its work is to ensure division in optimal payloads to the bees. Every source transaction can be splitted in maximal 16 transactions.</p>
<h2 id="working-logic">Working logic <a class="heading-anchor-permalink" href="#working-logic">#</a></h2>
<ul>
<li>User <strong>A</strong> sends signa with a message with destination account <strong>D</strong> to a bee <strong>B1</strong>.</li>
<li>B1 checks the amount. If is greater than 10 signa than deliver it to the hive <strong>H</strong>. If it is not, then it delivers the signa to destination D.</li>
<li>H checks the amount and divide in N optimal parts, sending it to random bees <strong>B?</strong>.</li>
<li>B? checks the amount and the loop can start again, or end with a transaction to D.</li>
</ul>
<h2 id="how-to-use">How to use <a class="heading-anchor-permalink" href="#how-to-use">#</a></h2>
<p>User A must send signa and a message to any bee. This message must be scrambled (XOR operation) with bee address and hive address. To make easier, check the website XXXXX where the calculation can be done. Set the destination, the amount to send (or the amount to be received by destination). The page will present the information need to make the transaction. Note that many contracts activations will cost a fee, around 2%. The value depends on how many hops will happen, but the webpage will show the exactly value. The process will take from 2 to 50 blocks until all balance to be delivered.</p>
<h2 id="error-handling">Error handling <a class="heading-anchor-permalink" href="#error-handling">#</a></h2>
<p>If user send any amount to the bees or hive without the right verification code, the contracts will refund the amount. But on second wrong in a row, the bees contracts will hold the balance. If this happen, contact me for reimbursement.</p>
<h2 id="nerdy-details">Nerdy details <a class="heading-anchor-permalink" href="#nerdy-details">#</a></h2>
<ul>
<li>Contracts with random delayed activation that will cause different transactions to mix during bounces</li>
<li>Binary messages between sender-contracts and contracts-contracts are human-unfriendly</li>
<li>Binary messages encoded with recipient bee address, so sending balance to same destination thru two different bees will have two different messages</li>
<li>Hive chooses bees order in a pseudo random way, using simple linear feedback shift register</li>
</ul>
<h2 id="master-of-confusion">Master of confusion <a class="heading-anchor-permalink" href="#master-of-confusion">#</a></h2>
<ul>
<li>Send in amounts multiple of one bee payload. The best is to send amount that will be received in 16 bees payloads.</li>
<li>Send also the same amount to self, or triangulating with a third account.</li>
</ul>
<h2 id="how-to-test">How to test <a class="heading-anchor-permalink" href="#how-to-test">#</a></h2>
<p>Contract is loaded in signum testnet and can be tested. Use the page <a href="https://deleterium.info/HiveTestnet/">https://deleterium.info/HiveTestnet/</a> for instructions. For more details check <code>SmartC Compiler</code> server on Discord.</p>
<h2 id="smart-contract-source-code">Smart contract source code <a class="heading-anchor-permalink" href="#smart-contract-source-code">#</a></h2>
<p>For the brave:</p>
<pre><code class="language-c">// Compilation options
// Choose only one to compile
//#define BEE_CONTRACT
#define HIVE_CONTRACT

// Use if compiling to SC-Simulator
//#define SIMULATOR

// Full size for 256 bees, otherwise 32 bees
#define FULL_SIZE

// Default values
#define HIVE_ACTIVATION 8687_7000
#define BEE_ACTIVATION 1036_3500
#define BEE_PAYLOAD 9_1707_1500

// Accounts information
#ifdef SIMULATOR
    #define HIVE_ACCOUNT 999
#else
    #define HIVE_ACCOUNT '??????'
#endif

// Used for sleep when contracts are under low load
#define MAX_SLEEP_MASK 0x07
#define MAX_SLEEP_HIVE 12
#define MAX_SLEEP_BEE 8

// Common options
//#pragma version 0.3
#pragma globalOptimization
#include APIFunctions

// Common variables
struct TXINFO {
    long txId;
    long timestamp;
    long sender;
    long amount;
    long recipient;
    long verifier;
} currentTX;
long nextSleep, queenBeeWithdraw;

#ifdef BEE_CONTRACT

    #program name Bee
    #program description Worker bee 
    #program activationAmount BEE_ACTIVATION

    #pragma maxAuxVars 2
    #pragma maxConstVars 1

    #ifdef SIMULATOR
        // Disregard first activation
        B_To_Address_Of_Creator();
        Send_All_To_Address_In_B();
    #endif
    const long hive = HIVE_ACCOUNT;
    const long beePayload = BEE_PAYLOAD;
    // Accept overload to avoid multiple bounce when amount is near bee payload
    const long triggerBounce = BEE_PAYLOAD + HIVE_ACTIVATION;
    // Queen Bee is the creator and also verifier for messages
    B_To_Address_Of_Creator();
    long queenBee = Get_B1();
    long ownAddress;

    // Phase 1
    // Worker bee has born. Inform hive.
    while (Get_Current_Balance() &lt; 2_9000_0000) {
        // Wait to have at least 2.9 signa for startup
        // Doing this way because SC can not loop
        //   thru messages received by multi-out payments
        halt;
    }
    Set_B1(hive);
    Set_A1_A2('newborn', queenBee);
    Send_A_To_Address_In_B();
    Send_To_Address_In_B(1_8000_0000);

    // Phase 2
    // Wait to know own name. Hive will set it.
    do {
        A_To_Tx_After_Timestamp(currentTX.timestamp);
        if (Get_A1() == 0) {
            halt;
            continue;
        }
        currentTX.amount = Get_Amount_For_Tx_In_A();
        currentTX.timestamp = Get_Timestamp_For_Tx_In_A();
        Message_From_Tx_In_A_To_B();
        ownAddress = Get_B1();
        currentTX.verifier = Get_B2();
        nextSleep = MAX_SLEEP_BEE - (Get_A1() &amp; MAX_SLEEP_MASK);
    } while (currentTX.verifier != 'ownAcc');

    // Inform success
    B_To_Address_Of_Creator();
    Set_A1_A2('Setup fi','nished!');
    Send_A_To_Address_In_B();
    Send_To_Address_In_B(Get_Current_Balance() - BEE_ACTIVATION);

    // Phase 3
    // Lifecycle of worker bee
    void main (void) {
        long lastRefundedAccount;

        // Lazy activation
        sleep nextSleep;

        // Loop thru transactions queue
        do {
            A_To_Tx_After_Timestamp(currentTX.timestamp);
            currentTX.txId = Get_A1();
            if (currentTX.txId == 0) {
                if (queenBeeWithdraw) {
                    // Process withdraw only when there is no more pending transactions
                    queenBeeWithdraw = false;
                    B_To_Address_Of_Creator();
                    Send_All_To_Address_In_B();
                    continue;
                }
                exit;
            }
            
            //fill transaction information
            currentTX.amount = Get_Amount_For_Tx_In_A();
            currentTX.timestamp = Get_Timestamp_For_Tx_In_A();
            Message_From_Tx_In_A_To_B();
            currentTX.recipient = Get_B1();
            currentTX.verifier = Get_B2();

            if (currentTX.verifier != queenBee) {
                // Instruction not from hive, refund.
                B_To_Address_Of_Tx_In_A();
                currentTX.sender = Get_B1();
                if (currentTX.sender == lastRefundedAccount) {
                    // Avoid situation where messages being bounced between bees
                    // If user send two consecutive wrong transactions, one must ask reimburse.
                    if (currentTX.sender == queenBee) {
                        // Creator can use this strategy to claim bee balance
                        queenBeeWithdraw = true;
                    }
                    continue;
                }
                lastRefundedAccount = currentTX.sender;
                Send_To_Address_In_B(currentTX.amount);
            } else if (currentTX.amount &gt; triggerBounce) {
                // Bounce transaction to hive
                Set_A1_A2(currentTX.recipient ^ ownAddress, queenBee);
                Set_B1(hive);
                Send_A_To_Address_In_B();
                Send_To_Address_In_B(currentTX.amount);
                sleep 1;
            } else {
                // End point
                Set_B1(currentTX.recipient ^ hive ^ ownAddress);
                Send_To_Address_In_B(currentTX.amount);
                nextSleep = MAX_SLEEP_BEE - (currentTX.txId &amp; MAX_SLEEP_MASK);
                sleep 1;
            }
        } while (true);
    }

#endif


#ifdef HIVE_CONTRACT

    #program name Hive
    #program description Manage the bee workers 
    #program activationAmount HIVE_ACTIVATION

    #pragma maxAuxVars 2
    #pragma maxConstVars 4

    #define DISPATCH_LOOP_ACTIVATION (67 * 7_3500)
    #ifdef FULL_SIZE
        #define HIVE_SIZE 256
        #define HIVE_SIZE_MASK 255
    #else
        #define HIVE_SIZE 32
        #define HIVE_SIZE_MASK 31
    #endif

    struct STATS {
        long welcomedBees, dispatchedBees;
    } stats;

    struct LSFR {
        long seed;
        long currentMagic;
        long magic[4];
    } lsfr;
    
    struct BEECONTROL {
        long lastBusyBee, currentBee, flushBees;
    } beeControl;

    const long n32 = 32, n61 = 61, n64 = 64;
    const lsfr.seed = 1;
    #ifdef FULL_SIZE
        const lsfr.magic[0] = 149;
        const lsfr.magic[1] = 166;
        const lsfr.magic[2] = 243;
        const lsfr.magic[3] = 250;
    #else
        const lsfr.magic[0] = 20;
        const lsfr.magic[1] = 23;
        const lsfr.magic[2] = 27;
        const lsfr.magic[3] = 30;
    #endif
    const long beePayload = BEE_PAYLOAD + BEE_ACTIVATION;
    const long bounceLoad = 16 * (BEE_PAYLOAD + BEE_ACTIVATION) + HIVE_ACTIVATION + BEE_ACTIVATION;
    const long doubleBounceLoad = 2 * 
        (16 * (BEE_PAYLOAD + BEE_ACTIVATION) + HIVE_ACTIVATION + BEE_ACTIVATION);
    const long squareBounceLoad = 16 * 
        (16 * (BEE_PAYLOAD + BEE_ACTIVATION) + HIVE_ACTIVATION + BEE_ACTIVATION) +
        HIVE_ACTIVATION + BEE_ACTIVATION;
    long triggerSquareBounceLoad = squareBounceLoad + bounceLoad;
    long queenBee, pseudoRandomSeed;
    long workerBee[HIVE_SIZE];

    #ifdef SIMULATOR
        // disregard first activation
        B_To_Address_Of_Creator();
        Send_All_To_Address_In_B();
    #endif

    // Queen Bee is the creator and also verifier for messages
    B_To_Address_Of_Creator();
    queenBee = Get_B1();
    // Setup phase
    setupHive();
    // Refund setup amount
    B_To_Address_Of_Creator();
    Set_A1_A2('Setup fi','nished!');
    Send_A_To_Address_In_B();
    Send_To_Address_In_B(Get_Current_Balance() - HIVE_ACTIVATION);

    void main(void) {
        long refundableDispatchLoops;

        // Lazy activation
        sleep MAX_SLEEP_HIVE - (pseudoRandomSeed &amp; MAX_SLEEP_MASK);
        lsfr.currentMagic = lsfr.magic[pseudoRandomSeed &amp; 3];
        beeControl.lastBusyBee = lsfr.seed;
        beeControl.flushBees = 0;

        // Loop thru transactions queue        // Use TxId as randomness source
        for (A_To_Tx_After_Timestamp(currentTX.timestamp);
            (currentTX.txId = Get_A1()) != 0;
            A_To_Tx_After_Timestamp(currentTX.timestamp))
        {
            //fill transaction information
            getTxDetails();
            // Seed new random
            pseudoRandomSeed = currentTX.txId;

            if (currentTX.verifier != queenBee) {
                B_To_Address_Of_Tx_In_A();
                currentTX.sender = Get_B1();
                // If user send two consecutive wrong messages, one must ask reimburse.
                if (Get_B1() == queenBee) {
                    // Creator can use this strategy to claim hive balance
                    queenBeeWithdraw = true;
                    continue;
                }
                // Not welcome bee... Refund
                Send_To_Address_In_B(currentTX.amount);
                continue;
            }

            stats.welcomedBees++;
            // Bees dispatch loop with optimal payloads
            refundableDispatchLoops = 15;
            if (currentTX.amount &gt;= doubleBounceLoad) {
                // minimum is bounceLoad
                while (currentTX.amount &gt;= doubleBounceLoad &amp;&amp; refundableDispatchLoops != 0) {
                    refundableDispatchLoops--;
                    if (currentTX.amount &gt;= triggerSquareBounceLoad) {
                        dispatchBee(squareBounceLoad);
                        currentTX.amount -= squareBounceLoad;
                    } else {
                        dispatchBee(bounceLoad);
                        currentTX.amount -= bounceLoad;
                    }
                }
            } else {
                // maximum is bounceLoad
                while (currentTX.amount &gt; beePayload &amp;&amp; refundableDispatchLoops != 0) {
                    refundableDispatchLoops--;
                    if (currentTX.amount &gt;= bounceLoad) {
                        dispatchBee(bounceLoad);
                        currentTX.amount -= bounceLoad;
                    } else {
                        dispatchBee(beePayload);
                        currentTX.amount -= beePayload;
                    }
                }
            }
            // Refund unused loops
            currentTX.amount += refundableDispatchLoops * DISPATCH_LOOP_ACTIVATION;
            // Last bee with remaining balance, if any.
            if (currentTX.amount &gt; BEE_ACTIVATION) {
                // Only send balance to bee if it will be processed.
                dispatchBee(currentTX.amount);
            }
        }

        if (queenBeeWithdraw) {
            // Process withdraw only when there is no more pending transactions
            queenBeeWithdraw = false;
            B_To_Address_Of_Creator();
            Send_To_Address_In_B(Get_Current_Balance() - HIVE_ACTIVATION);
        }
    }

    // Controll bee dispatch, choose bee and send transaction
    void dispatchBee(long amount) {
        if (beeControl.flushBees == 2) {
            // Flush all bees
            sleep 1;
            lsfr.currentMagic = lsfr.magic[pseudoRandomSeed &amp; 3];
            // beeControl.lastBusyBee = lsfr.seed;
            beeControl.flushBees = 0;
        }
        if (beeControl.flushBees == 1) {
            // Use bee zero but next time flush all
            beeControl.currentBee = 0;
            beeControl.flushBees = 2;
        } else {
            // Pick a 'random' bee using linear-feedback shift register
            if (!(lsfr.seed &amp; 1)){
                lsfr.seed &gt;&gt;= 1;
            } else {
                lsfr.seed &gt;&gt;= 1;
                lsfr.seed ^= lsfr.currentMagic;
            }
            beeControl.currentBee = lsfr.seed;
            
            if (beeControl.currentBee == beeControl.lastBusyBee) {
                // Use last bee and signal to use bee zero next time
                beeControl.flushBees = 1;
            }
        }
        // Dispatch transaction
        Set_B1(workerBee[beeControl.currentBee]);
        Set_A1_A2(workerBee[beeControl.currentBee] ^ currentTX.recipient, queenBee);
        Send_A_To_Address_In_B();
        Send_To_Address_In_B(amount);
        // Update stats
        stats.dispatchedBees++;
    }

    // Flow control receiving and responding bees start up. Only these transactions
    // will be processed.
    void setupHive(void) {
        do {
            A_To_Tx_After_Timestamp(currentTX.timestamp);
            if (Get_A1() == 0) {
                halt;
                continue;
            }
            // Fill transaction information
            getTxDetails();
            B_To_Address_Of_Tx_In_A();
            currentTX.sender = Get_B1();
            if (currentTX.recipient == 'newborn' &amp;&amp; currentTX.verifier == queenBee) {
                // Add new worker bee to database
                workerBee[stats.welcomedBees] = currentTX.sender;
                stats.welcomedBees++;
                // Seed random with txid
                pseudoRandomSeed = Get_A1();
                // Inform worker bee his name
                Set_A1_A2(currentTX.sender, 'ownAcc');
                Set_B1(currentTX.sender);
                Send_A_To_Address_In_B();
                Send_To_Address_In_B(currentTX.amount);
            }
        } while (stats.welcomedBees != workerBee.length);
    }

    void getTxDetails(void) {
        currentTX.amount = Get_Amount_For_Tx_In_A();
        currentTX.timestamp = Get_Timestamp_For_Tx_In_A();
        Message_From_Tx_In_A_To_B();
        currentTX.recipient = Get_B1();
        currentTX.verifier = Get_B2();
    }

#endif
</code></pre>

      </article>
    </div>
    <script>
      // Load contents.json if you need it
    </script>
    <script>
      // FROM http://purecss.io/js/ui.js
      (function(window, document) {
        var layout = document.getElementById("layout"),
          menu = document.getElementById("menu"),
          menuLink = document.getElementById("menuLink");

        function toggleClass(element, className) {
          var classes = element.className.split(/\s+/),
            length = classes.length,
            i = 0;

          for (; i < length; i++) {
            if (classes[i] === className) {
              classes.splice(i, 1);
              break;
            }
          }
          // The className is not found
          if (length === classes.length) {
            classes.push(className);
          }

          element.className = classes.join(" ");
        }

        menuLink.onclick = function(e) {
          var active = "active";

          e.preventDefault();
          toggleClass(layout, active);
          toggleClass(menu, active);
          toggleClass(menuLink, active);
        };
      })(this, this.document);
    </script>
  </body>
</html>
