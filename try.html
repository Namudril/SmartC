<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<link rel="stylesheet" href="style-try.css">


<script src="src/tokenizer.js"></script>
<script src="src/parser.js"></script>
<script src="src/verifier.js"></script>
<script src="src/shape.js"></script>
<script src="src/syntax.js"></script>
<script src="src/generator.js"></script>
<script src="src/testcases.js"></script>
<script src="src/bytecode.js"></script>

<script src="src/asm_highlight.js"></script>

<script>

function compileCode(){

    var codeString = document.getElementById("source-code").value;
    var token_output, parser_output, ver_output, big_ast, big_ast_opTree;

    try{
        if (document.getElementById("source_is_c").checked) {
            token_output = tokenizer(codeString);
            parser_output = parser(token_output);
            ver_output = verify(parser_output);
            big_ast = shapeProgram(ver_output);
            big_ast_opTree = bigastProcessSyntax(big_ast);
            asmCode = bigastCompile(big_ast_opTree);
        } else {
            asmCode = codeString
        }

        document.getElementById("assembly_output").innerHTML = asm_highlight(asmCode);
        var bcode = bytecode(asmCode);

        //document.getElementById("machine-code").innerHTML = asmCode+"\n\n"+asmCode.replace(/\n/g,"\\n")+"\n\n"+JSON.stringify(big_ast_opTree, null, '    ');
        //document.getElementById("machine-code").innerHTML = asmCode+"\n\n"+JSON.stringify(big_ast_opTree, null, '    ');
        //document.getElementById("machine-code").innerHTML = JSON.stringify(bcode, stringifyReplacer , '    ');
        //document.getElementById("c_output").innerHTML = JSON.stringify(bcode, null , '    ');
        var msg="<span class='msg_success'>Compile sucessfull!!!</span>";
        if (document.getElementById("debug").checked) {
            msg+="\n\n"+JSON.stringify(bcode, null , '    ')
        }
        document.getElementById("c_output").innerHTML = msg;

        fill_form(bcode);

    }catch (e) {
        document.getElementById("assembly_output").innerHTML = "";
        clear_form();
        var msg = "<span class='msg_failure'>Compile failed</span>\n\n"+e.message;
        if (document.getElementById("debug").checked) {
            msg+="\n\n"+e.stack;
        }
        document.getElementById("c_output").innerHTML = msg;
    }
}

function onLoad() {
    var scode = document.getElementById("source-code");
    //scode.addEventListener('mousemove', showTooltip);
    scode.addEventListener('keyup',textKeyUp);
    scode.addEventListener('click',textKeyUp);

    document.getElementById("compile").addEventListener('click', compileCode);
    document.getElementById("test").addEventListener('click', testCode);
    document.getElementById("source_is_c").addEventListener('click', toggleLang);

    textKeyUp();
    toggleLang(document.getElementById("source_is_c"));
}

function textKeyUp () {
    var elem = document.getElementById("source-code");
    var text = elem.value;
    var i;

    // grows text area
    var oldrow = elem.rows;
    var newrow = (text.match(/\n/g) || '').length + 2;

    //eye-candy (resize in 8 steps using polinomial interpolation)
    i=1;
    var end=9;
    var id;
    function frame() {
        if (i>9) {
            clearInterval(id);
        } else {
            i++;
            elem.rows = Math.round( i*i*(oldrow -newrow)/(end*end) + i*(newrow - oldrow)*(2/end) + oldrow);
        }
    }
    if (newrow-oldrow > 3 || newrow-oldrow < -3) id=setInterval(frame, 100);
    else elem.rows = newrow;
    //eye-candy end

    //if coding in assembly, update also assembly output.
    if (document.getElementById("source_is_c").checked === false) {
        document.getElementById("assembly_output").innerHTML = asm_highlight(document.getElementById("source-code").value);
    }

    //update tooltip info (line:column)
    var cpos = elem.value.substr(0, elem.selectionStart).split("\n");
    document.getElementById("tooltip_span").innerHTML="Cursor: "+ cpos.length + ":"+cpos[cpos.length-1].length;
}

/* debug use only
function stringifyReplacer(key, value) {
    if (typeof value === 'bigint') {
        return value.toString(16) + 'n';
    } else if (typeof value === 'number'){
        return value.toString(16);
    } else {
        return value;
    }
}
*/

function fill_form(AT_Info) {

    var my_dom;
    my_dom = document.getElementsByName("code");
    my_dom[0].value=AT_Info.ByteCode;
    my_dom = document.getElementsByName("dpages");
    my_dom[0].value=AT_Info.DataPages;
    my_dom = document.getElementsByName("cspages");
    my_dom[0].value=AT_Info.CodeStackPages;
    my_dom = document.getElementsByName("uspages");
    my_dom[0].value=AT_Info.UserStackPages;
    my_dom = document.getElementsByName("feeNQT");
    my_dom[0].value=AT_Info.MinimumFeeNQT;
}

function clear_form(){
    var my_dom;
    my_dom = document.getElementsByName("code");
    my_dom[0].value="";
    my_dom = document.getElementsByName("dpages");
    my_dom[0].value="0";
    my_dom = document.getElementsByName("cspages");
    my_dom[0].value="0";
    my_dom = document.getElementsByName("uspages");
    my_dom[0].value="0";
    my_dom = document.getElementsByName("feeNQT");
    my_dom[0].value="0";
}

function testCode() {
    document.getElementById("assembly_output").innerHTML = "";
    clear_form();
    document.getElementById("c_output").innerHTML = runTestCases();
}

function toggleLang(ev) {
    if ((ev.checked !== undefined && ev.checked) || (ev.target !== undefined && ev.target.checked)) {
        document.getElementById("bt1").innerText = "C";
    } else {
        document.getElementById("bt1").innerText = "Assembly";
    }
    document.getElementById("assembly_output").innerHTML = "";
}

function deployClick(deploy_port) {
    var form_dom = document.getElementById("deploy_form");
    form_dom.action = "http://localhost:"+deploy_port.value+"/burst";
}

</script>
</head>

<body onload='javascript:onLoad()'>
    <h1>BurstAT-CC - Burstcoin AT C Compiler</h1>
    <p>More information about this project, documentation or examples, visit <a href="https://deleterium.github.io/BurstAT-CC/">https://deleterium.github.io/BurstAT-CC/</a> or
        <a href="https://github.com/deleterium/BurstAT-CC">https://github.com/deleterium/BurstAT-CC</a></p>

    <div class="div_full">
        <textarea id="source-code" placeholder="Write here your program." class="inc_height" spellcheck="false" wrap="off"></textarea>
        <span id="tooltip_span" class="tooltip">Cursor: 0:0</span>
    </div>

    <div class="div_options">
        <input type="checkbox" id="source_is_c" checked="true" style="display: none;">
        <input type="checkbox" id="debug" style="display: none;">
        <label for="source_is_c" class="btn_class" id="bt1" title="Toggle source language">C</label>
        <button id="compile" class="btn_class">Compile it!</button>
        <button id="test" class="btn_class" >Run test cases</button>
        <label for="debug" class="btn_class" id="bt2" title="Debug" title="Show more information">Debug</label>
    </div>

    <div class="div_full">
        <fieldset><legend>Status:</legend>
            <pre id="c_output"></pre>
        </fieldset>
    </div>

    <div class="left">
        <fieldset><legend>Localhost node deployment form for smart contract:</legend>
        <table class="table">
            <tbody>
            <tr><td>Deployment:</td><td>
                <label title="localhost:6876" class="default"><input type="radio" onclick="deployClick(this);" value="6876" name="deploy" checked="true"> Testnet </label>&nbsp;&nbsp;
                <label title="localhost:8125" class="default"><input type="radio" onclick="deployClick(this);" value="8125" name="deploy"> Main </label></td></tr>
        <form action="http://localhost:6876/burst" method="POST" target="formresponse" id="deploy_form" >
        <input type="hidden" name="requestType" value="createATProgram">
            <tr><td>Contract Name:</td><td><input type="text" name="name" style="width:100%;min-width:200px;" pattern="[a-zA-Z0-9]{1,10}" title="Only letters (a to Z) and numbers"></td></tr>
            <tr><td>Description:</td><td><textarea name="description" rows="5" style="width:100%;min-width:200px;"></textarea></td></tr>
            <!-- <tr><td>creationBytes:</td><td><input type="text" name="creationBytes" style="width:100%;min-width:200px;"></td></tr> -->
            <tr><td>Bytecode:</td><td><input type="text" name="code" style="width:100%;min-width:200px;" pattern="[a-fA-F0-9]{1,}"></td></tr>
            <!-- <tr><td>data:</td><td><input type="text" name="data" style="width:100%;min-width:200px;"></td></tr> -->
            <tr><td>Data Pages:</td><td><input type="number" name="dpages" value="1" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>Code Stack Pages:</td><td><input type="number" name="cspages" value="0" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>User Stack Pages:</td><td><input type="number" name="uspages" value="0" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>Min. Activation Amount NQT:</td><td><input type="text" name="minActivationAmountNQT" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>Secret Phrase:</td><td><input type="password" name="secretPhrase" style="width:100%;min-width:200px;"></td></tr>
            <!-- <tr><td>publicKey:</td><td><input type="text" name="publicKey" style="width:100%;min-width:200px;"></td></tr> -->
            <tr><td>Fee (NQT):</td><td><input type="text" name="feeNQT" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>Tx Deadline (minutes):</td><td><input type="text" name="deadline" style="width:100%;min-width:200px;" value="24"></td></tr>
            <!-- <tr><td>referencedTransactionFullHash:</td><td><input type="text" name="referencedTransactionFullHash" style="width:100%;min-width:200px;"></td></tr> -->
            <tr><td>Broadcast Tx?</td><td><input type="text" name="broadcast" style="width:100%;min-width:200px;" placeholder="true"></td></tr>
            <!--
            <tr><td>message:</td><td><input type="text" name="message" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>messageIsText:</td><td><input type="text" name="messageIsText" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>messageToEncrypt:</td><td><input type="text" name="messageToEncrypt" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>messageToEncryptIsText:</td><td><input type="text" name="messageToEncryptIsText" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>encryptedMessageData:</td><td><input type="text" name="encryptedMessageData" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>encryptedMessageNonce:</td><td><input type="text" name="encryptedMessageNonce" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>messageToEncryptToSelf:</td><td><input type="text" name="messageToEncryptToSelf" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>messageToEncryptToSelfIsText:</td><td><input type="text" name="messageToEncryptToSelfIsText" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>encryptToSelfMessageData:</td><td><input type="text" name="encryptToSelfMessageData" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>encryptToSelfMessageNonce:</td><td><input type="text" name="encryptToSelfMessageNonce" style="width:100%;min-width:200px;"></td></tr>
            <tr><td>recipientPublicKey:</td><td><input type="text" name="recipientPublicKey" style="width:100%;min-width:200px;"></td></tr>
            -->
            <tr><td colspan="2"><input type="submit" class="btn btn-default" value="submit"></td></tr>
        </form>
            </tbody>
        </table>
        <h5>Response:</h5>
        <iframe src="about:blank" name='formresponse' width='100%' height='300'></iframe>
        </fieldset>
    </div>

    <div class="right">
        <fieldset><legend>Assembly output:</legend>
            <pre id="assembly_output"></pre>
        </fieldset>
    </div>

</body>
</html>
